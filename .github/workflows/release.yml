name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  tests:
    name: Test & Clippy (native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-default

      - name: Run tests and clippy
        run: |
          nix develop .#default --command bash -c "
            cargo test --all --release
            cargo test --all --release --features otel
            cargo test --all --release --features nif
            cargo clippy --all-targets -- -D warnings
            cargo clippy --all-targets --features otel -- -D warnings
            cargo clippy --all-targets --features nif -- -D warnings
            cargo fmt --all -- --check
          "

  package-crate:
    name: Package Crate
    needs: tests
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      checksum: ${{ steps.package.outputs.checksum }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Get Version
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: Package
        id: package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          nix develop .#default --command bash -c "
            # Set version from tag
            sed -i \"s/^version = .*/version = \\\"${VERSION}\\\"/\" Cargo.toml

            mkdir -p priv/native
            # Build NIF and stage into crate
            cargo build --release --features nif --no-default-features
            cp target/release/libchunker.so priv/native/libchunker_nif-x86_64-linux.so
            cargo package --allow-dirty
          "
          # Calculate checksum
          CRATE_FILE=$(ls target/package/*.crate)
          CHECKSUM=$(sha256sum "$CRATE_FILE" | cut -d' ' -f1)
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Checksum: $CHECKSUM"

      - name: Package NIF Binary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TARGET="x86_64-unknown-linux-gnu"

          # Create tarball in rustler_precompiled format
          mkdir -p nif-release
          cp target/release/libchunker.so nif-release/
          cd nif-release
          tar -czvf "libchunker_nif-${VERSION}-${TARGET}.tar.gz" libchunker.so

          # Calculate checksum for NIF
          sha256sum "libchunker_nif-${VERSION}-${TARGET}.tar.gz" > "libchunker_nif-${VERSION}-${TARGET}.tar.gz.sha256"
          echo "ðŸ“¦ NIF tarball created: libchunker_nif-${VERSION}-${TARGET}.tar.gz"

      - name: Upload Crate
        uses: actions/upload-artifact@v4
        with:
          name: crate
          path: target/package/*.crate

      - name: Upload NIF Binary
        uses: actions/upload-artifact@v4
        with:
          name: nif-binary
          path: nif-release/*.tar.gz*

  publish-release:
    name: Publish to GitHub Release
    needs: [package-crate]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.crate
            artifacts/*.tar.gz
            artifacts/*.sha256
          fail_on_unmatched_files: false
          generate_release_notes: true

  update-index:
    name: Update Crate Index
    needs: [package-crate, publish-release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout crate-index
        uses: actions/checkout@v4
        with:
          repository: FlakeCache/crate-index
          token: ${{ secrets.CRATE_INDEX_TOKEN }}
          path: crate-index

      - name: Update index
        run: |
          VERSION="${{ needs.package-crate.outputs.version }}"
          CHECKSUM="${{ needs.package-crate.outputs.checksum }}"

          cd crate-index

          # Append new version to index (each line is a JSON object)
          echo '{"name":"chunker","vers":"'"$VERSION"'","deps":[],"cksum":"'"$CHECKSUM"'","features":{},"yanked":false}' >> ch/un/chunker

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ch/un/chunker
          git commit -m "Add chunker v$VERSION"
          git push
