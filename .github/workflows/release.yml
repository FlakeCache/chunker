name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  tests:
    name: Test & Clippy (native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-default

      - name: Run tests and clippy
        run: |
          nix develop .#default --command bash -c "
            cargo test --all --release
            cargo test --all --release --features telemetry
            cargo test --all --release --features nif
            cargo clippy --all-targets -- -D warnings
            cargo clippy --all-targets --features telemetry -- -D warnings
            cargo clippy --all-targets --features nif -- -D warnings
            cargo fmt --all -- --check
            cargo build --release --all-features --bin chunker
            stat -c \"%n %s\" target/release/chunker > size-default.txt
          "

  package-crate:
    name: Package Crate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Package
        run: |
          nix develop .#default --command bash -c "
            cargo package
          "
      - name: Upload Crate
        uses: actions/upload-artifact@v4
        with:
          name: crate
          path: target/package/*.crate

  build-release:
    name: Build ${{ matrix.variant }}
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        include:
          # 1. Generic (Portable)
          - variant: "generic"
            rustflags: ""
            suffix: "x86_64-unknown-linux-gnu"
            build_loader: true
            target: "x86_64-unknown-linux-gnu"
            use_cross: false
          
          # 2. x86-64-v3 (Haswell+) - AVX2
          - variant: "v3"
            rustflags: "-C target-cpu=x86-64-v3"
            suffix: "x86_64-unknown-linux-gnu-v3"
            build_loader: false
            target: "x86_64-unknown-linux-gnu"
            use_cross: false

          # 3. x86-64-v4 (Skylake-X/Zen4+) - AVX-512
          - variant: "v4"
            rustflags: "-C target-cpu=x86-64-v4"
            suffix: "x86_64-unknown-linux-gnu-v4"
            build_loader: false
            target: "x86_64-unknown-linux-gnu"
            use_cross: false

          # 4. ARM64 Generic (Linux)
          - variant: "arm64-generic"
            rustflags: ""
            suffix: "aarch64-unknown-linux-gnu"
            build_loader: true
            target: "aarch64-unknown-linux-gnu"
            use_cross: false
            use_zig: true

          # 5. ARM64 SVE (Linux)
          - variant: "arm64-sve"
            rustflags: "-C target-feature=+sve"
            suffix: "aarch64-unknown-linux-gnu-sve"
            build_loader: false
            target: "aarch64-unknown-linux-gnu"
            use_cross: false
            use_zig: true

          # 6. macOS ARM64 (Apple Silicon)
          # Cross-compiled from Linux using cargo-zigbuild
          - variant: "macos-arm64"
            rustflags: ""
            suffix: "aarch64-apple-darwin"
            build_loader: true
            target: "aarch64-apple-darwin"
            use_cross: false
            use_zig: true

          # 7. Windows x86_64 (MSVC)
          # Cross-compiled from Linux using cargo-zigbuild
          - variant: "windows-x64"
            rustflags: ""
            suffix: "x86_64-pc-windows-msvc"
            build_loader: true
            target: "x86_64-pc-windows-msvc"
            use_cross: false
            use_zig: true

          # 8. Windows ARM64 (MSVC)
          - variant: "windows-arm64"
            rustflags: ""
            suffix: "aarch64-pc-windows-msvc"
            build_loader: true
            target: "aarch64-pc-windows-msvc"
            use_cross: false
            use_zig: true
            nix_shell: "cross-windows"

          # 9. Linux Musl (Static) - Alpine / Scratch
          - variant: "linux-musl"
            rustflags: "-C target-feature=+crt-static"
            suffix: "x86_64-unknown-linux-musl"
            build_loader: false
            target: "x86_64-unknown-linux-musl"
            use_cross: false
            use_zig: true
            nix_shell: "linux"

          # 10. Linux ARMv7 (IoT / Raspberry Pi 2/3)
          - variant: "linux-armv7"
            rustflags: ""
            suffix: "armv7-unknown-linux-gnueabihf"
            build_loader: false
            target: "armv7-unknown-linux-gnueabihf"
            use_cross: false
            use_zig: true
            nix_shell: "cross-linux"

          # 11. Linux RISC-V (VisionFive 2 / Server)
          - variant: "linux-riscv64"
            rustflags: ""
            suffix: "riscv64gc-unknown-linux-gnu"
            build_loader: false
            target: "riscv64gc-unknown-linux-gnu"
            use_cross: false
            use_zig: true
            nix_shell: "cross-linux"

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.target }}

      - name: Build & Sign
        run: |
          # Default to 'default' shell if not specified (for backward compat)
          SHELL_NAME="${{ matrix.nix_shell || 'default' }}"
          
          nix develop .#$SHELL_NAME --command bash -c "
            set -e
            echo 'üèóÔ∏è Building ${{ matrix.variant }}...'
            
            if [ '${{ matrix.use_cross }}' = 'true' ]; then
              cross build --release --target ${{ matrix.target }}
            elif [ '${{ matrix.use_zig }}' = 'true' ]; then
              cargo zigbuild --release --target ${{ matrix.target }}
            else
              cargo build --release --target ${{ matrix.target }}
            fi
            
            # Prepare Artifacts
            mkdir -p dist
            if [[ '${{ matrix.target }}' == *'windows'* ]]; then EXT='.exe'; else EXT=''; fi
            SRC_DIR='target/${{ matrix.target }}/release'
            
            VERSION="${{ github.ref_name }}"
            
            # Copy Binary
            cp \$SRC_DIR/chunker\$EXT dist/chunker-\$VERSION-${{ matrix.suffix }}\$EXT
            
            # Copy Loader
            if [ '${{ matrix.build_loader }}' = 'true' ]; then
              cp \$SRC_DIR/loader\$EXT dist/chunker-loader-\$VERSION-${{ matrix.suffix }}\$EXT
            fi
            
            # üõ°Ô∏è Generate SBOM (Software Bill of Materials)
            echo 'üìù Generating SBOM...'
            syft scan file:dist/chunker-\$VERSION-${{ matrix.suffix }}\$EXT -o spdx-json=dist/chunker-\$VERSION-${{ matrix.suffix }}.spdx.json

            # Checksums for integrity verification
            (cd dist && sha256sum * > SHA256SUMS)

            # Size report for regression tracking
            stat -c \"%n %s\" dist/* > dist/SIZE.txt

            # Compress artifacts (keep originals for convenience)
            (cd dist && for f in *; do if [ -f \"$f\" ]; then zstd -19 --keep \"$f\"; fi; done)
            
            # üîê Sign Artifacts (using Cosign keyless / OIDC)
            # Note: In a real run, this requires ID_TOKEN permissions.
            # For self-hosted without OIDC, you might use a key file.
            # echo '‚úçÔ∏è Signing...'
            # cosign sign-blob --yes dist/chunker-${{ matrix.suffix }}\$EXT --bundle dist/chunker-${{ matrix.suffix }}.sig
          "
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
          # COSIGN_EXPERIMENTAL: "1" # Needed for keyless signing

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chunker-${{ matrix.suffix }}
          path: dist/

  publish-release:
    name: Publish to GitHub Release
    needs: [build-release, package-crate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          fail_on_unmatched_files: false
          generate_release_notes: true
