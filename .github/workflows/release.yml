name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  tests:
    name: Test & Clippy (native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-default

      - name: Run tests and clippy
        run: |
          nix develop .#default --command bash -c "
            cargo test --all --release
            cargo test --all --release --features otel
            cargo test --all --release --features nif
            cargo clippy --all-targets -- -D warnings
            cargo clippy --all-targets --features otel -- -D warnings
            cargo clippy --all-targets --features nif -- -D warnings
            cargo fmt --all -- --check
          "

  package-crate:
    name: Package Crate
    needs: tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Package
        run: |
          VERSION="${GITHUB_REF_NAME}"
          nix develop .#default --command bash -c "
            # Set version from tag
            sed -i \"s/^version = .*/version = \\\"${VERSION#v}\\\"/\" Cargo.toml

            mkdir -p priv/native
            # Build NIF and stage into crate
            cargo build --release --features nif --no-default-features
            cp target/release/libchunker.so priv/native/libchunker_nif-x86_64-linux.so
            cargo package --allow-dirty
          "
      - name: Upload Crate
        uses: actions/upload-artifact@v4
        with:
          name: crate
          path: target/package/*.crate

  publish-release:
    name: Publish to GitHub Release
    needs: [package-crate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.crate
          fail_on_unmatched_files: false
          generate_release_notes: true
