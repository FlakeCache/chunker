name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  tests:
    name: Test & Clippy (native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-default

      - name: Run tests and clippy
        run: |
          nix develop .#default --command bash -c "
            cargo test --all --release
            cargo test --all --release --features telemetry
            cargo test --all --release --features nif
            cargo clippy --all-targets -- -D warnings
            cargo clippy --all-targets --features telemetry -- -D warnings
            cargo clippy --all-targets --features nif -- -D warnings
            cargo fmt --all -- --check
            cargo build --release --all-features --bin chunker
            stat -c \"%n %s\" target/release/chunker > size-default.txt
          "

  package-crate:
    name: Package Crate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Package
        run: |
          nix develop .#default --command bash -c "
            cargo build --release --features nif
            mkdir -p priv/native
            cp target/release/libchunker.so priv/native/libchunker_nif-x86_64-linux.so
            cargo build --release --bin chunker
            cargo build --release --bin loader
            mkdir -p bin
            cp target/release/chunker bin/
            cp target/release/loader bin/
            cargo package
          "
      - name: Upload Crate
        uses: actions/upload-artifact@v4
        with:
          name: crate
          path: target/package/*.crate

  build-release:
    name: Build ${{ matrix.variant }}
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        include:
          # Minimal matrix: we only need a Linux x86_64 build for the NIF
          - variant: "generic"
            rustflags: ""
            suffix: "x86_64-unknown-linux-gnu"
            build_loader: true
            target: "x86_64-unknown-linux-gnu"
            use_cross: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-${{ matrix.target }}

      - name: Build & Sign
        run: |
          # Default to 'default' shell if not specified (for backward compat)
          SHELL_NAME="${{ matrix.nix_shell || 'default' }}"
          
          nix develop .#$SHELL_NAME --command bash -c "
            set -e
            echo 'üèóÔ∏è Building ${{ matrix.variant }}...'
            
            if [ '${{ matrix.use_cross }}' = 'true' ]; then
              cross build --release --target ${{ matrix.target }}
            elif [ '${{ matrix.use_zig }}' = 'true' ]; then
              cargo zigbuild --release --target ${{ matrix.target }}
            else
              cargo build --release --target ${{ matrix.target }}
            fi
            
            # Prepare Artifacts
            mkdir -p dist
            if [[ '${{ matrix.target }}' == *'windows'* ]]; then EXT='.exe'; else EXT=''; fi
            SRC_DIR='target/${{ matrix.target }}/release'
            
            VERSION="${{ github.ref_name }}"
            
            # Copy Binary
            cp \$SRC_DIR/chunker\$EXT dist/chunker-\$VERSION-${{ matrix.suffix }}\$EXT
            
            # Copy Loader
            if [ '${{ matrix.build_loader }}' = 'true' ]; then
              cp \$SRC_DIR/loader\$EXT dist/chunker-loader-\$VERSION-${{ matrix.suffix }}\$EXT
            fi
            
            # üõ°Ô∏è Generate SBOM (Software Bill of Materials)
            echo 'üìù Generating SBOM...'
            syft scan file:dist/chunker-\$VERSION-${{ matrix.suffix }}\$EXT -o spdx-json=dist/chunker-\$VERSION-${{ matrix.suffix }}.spdx.json

            # Checksums for integrity verification
            (cd dist && sha256sum * > SHA256SUMS)

            # Size report for regression tracking
            stat -c \"%n %s\" dist/* > dist/SIZE.txt

            # Compress artifacts (keep originals for convenience)
            (cd dist && for f in *; do if [ -f \"$f\" ]; then zstd -19 --keep \"$f\"; fi; done)
            
            # üîê Sign Artifacts (using Cosign keyless / OIDC)
            # Note: In a real run, this requires ID_TOKEN permissions.
            # For self-hosted without OIDC, you might use a key file.
            # echo '‚úçÔ∏è Signing...'
            # cosign sign-blob --yes dist/chunker-${{ matrix.suffix }}\$EXT --bundle dist/chunker-${{ matrix.suffix }}.sig
          "
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
          # COSIGN_EXPERIMENTAL: "1" # Needed for keyless signing

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chunker-${{ matrix.suffix }}
          path: dist/

  publish-release:
    name: Publish to GitHub Release
    needs: [build-release, package-crate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
      
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/*.zst
            artifacts/*.spdx.json
            artifacts/SHA256SUMS
            artifacts/SIZE.txt
          fail_on_unmatched_files: false
          generate_release_notes: true
